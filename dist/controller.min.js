"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Controller=void 0;const elasticsearch_1=require("@elastic/elasticsearch"),sortObj=require("sort-object"),helpers_1=require("./helpers"),ASHelper=require("./helpers/advanced-helper"),parsers_1=require("./parsers");class Controller{constructor(config){this.postTest=(event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const body=JSON.parse(event.body),response=body;return helpers_1.HttpHelper.returnOkResponse(response)})),this.getTest=(event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const response="dummy string";return helpers_1.HttpHelper.returnOkResponse(response)})),this.getNavigation=(_event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const{baseUrl:baseUrl,parsers:parsers}=this.config,data=JSON.parse(yield helpers_1.HttpHelper.doRequest(baseUrl+"menu")),parser=new parsers.menu,response=parser.parse(data);return helpers_1.HttpHelper.returnOkResponse(response)})),this.getHomeLayout=(event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const{baseUrl:baseUrl,parsers:parsers,configurations:configurations}=this.config,keyOrder=JSON.parse(event.body),data=JSON.parse(yield helpers_1.HttpHelper.doRequest(baseUrl+"layout/home")),parser=new parsers.home,response=parser.parse({data:data,options:{keyOrder:keyOrder,conf:configurations.home}});return helpers_1.HttpHelper.returnOkResponse(response)})),this.getSearchDescription=(event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const{baseUrl:baseUrl,parsers:parsers}=this.config,{searchId:searchId}=event.pathParameters,data=JSON.parse(yield helpers_1.HttpHelper.doRequest(baseUrl+"layout/"+searchId)),parser=new parsers.searchDescription,response=parser.parse({data:data});return helpers_1.HttpHelper.returnOkResponse(response)})),this.getTimeline=(event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const{baseUrl:baseUrl,parsers:parsers}=this.config,{id:id}=event.pathParameters,data=JSON.parse(yield helpers_1.HttpHelper.doRequest(baseUrl+"views/"+id)),parser=new parsers.timeline,response=parser.parse({data:data});return helpers_1.HttpHelper.returnOkResponse(response)})),this.getMap=(event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const{baseUrl:baseUrl,parsers:parsers}=this.config,{id:id}=event.pathParameters,data=JSON.parse(yield helpers_1.HttpHelper.doRequest(baseUrl+"views/"+id)),parser=new parsers.map,response=parser.parse({data:data});return helpers_1.HttpHelper.returnOkResponse(response)})),this.getResource=(event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const{baseUrl:baseUrl,parsers:parsers,configurations:configurations}=this.config;let{type:type,id:id,sections:sections}=JSON.parse(event.body);const requestURL=baseUrl,url=requestURL+type+"/"+id,data=JSON.parse(yield helpers_1.HttpHelper.doRequest(url)),parser=new parsers.resource,response=parser.parse({data:data,options:{type:type,conf:configurations.resources[type]}}),sect=sortObj(response.sections,sections);return response.sections=sect,helpers_1.HttpHelper.returnOkResponse(response)})),this.search=(event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const{parsers:parsers,searchIndex:searchIndex,elasticUri:elasticUri,configurations:configurations}=this.config,body=JSON.parse(event.body),{type:type}=event.pathParameters,params=helpers_1.ESHelper.buildQuery(body,configurations.search,type);console.log(JSON.stringify(params));const query_res=yield helpers_1.ESHelper.makeSearch(searchIndex,params,elasticsearch_1.Client,elasticUri),data="results"===type?query_res.hits.hits:query_res.aggregations,parser=new parsers.search,{searchId:searchId,facets:facets}=body,{limit:limit,offset:offset,sort:sort}=body.results?body.results:"null";let total_count=query_res.hits.total.value;const response=parser.parse({data:data,options:{type:type,offset:offset,sort:sort,limit:limit,total_count:total_count,searchId:searchId,facets:facets,conf:configurations.search}});return helpers_1.HttpHelper.returnOkResponse(response)})),this.advancedSearch=(event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const{parsers:parsers,searchIndex:searchIndex,elasticUri:elasticUri,teiPublisherUri:teiPublisherUri,configurations:configurations}=this.config,body=JSON.parse(event.body),parser=new parsers_1.AdvancedSearchParser,params=parser.buildAdvancedQuery(body,configurations),query_res=yield helpers_1.ESHelper.makeSearch(searchIndex,params,elasticsearch_1.Client,elasticUri),es_data=query_res.hits.hits;let map_data={};es_data.map(res=>{if(res._source.xml_filename){const xml_filename=res._source.xml_filename;map_data[xml_filename]=res}});const docs=Object.keys(map_data),teiPublisherParams=yield parser.buildTextViewerQuery(body,this.config,docs);let total_count=query_res.hits.total.value;var data=[];if(teiPublisherParams){const collectionUri=this.config.teiPublisherUri+"mrcsearch",doc=yield helpers_1.HttpHelper.doRequest(collectionUri+"?"+teiPublisherParams),textViewerResults=ASHelper.buildTextViewerResults(doc);let matches_result=textViewerResults;es_data.map(res=>{if(res._source.xml_filename)for(let key in matches_result)key===res._source.xml_filename&&(res.highlight||(res.highlight={}),res.highlight.text_matches=matches_result[key].matches,data.push(res))}),total_count=data.length}else data=es_data;const{searchId:searchId}=body,{limit:limit,offset:offset,sort:sort}=body.results?body.results:"null",response=parser.advancedParseResults({data:data,options:{offset:offset,sort:sort,limit:limit,total_count:total_count,searchId:searchId,conf:configurations.advanced_search}});return helpers_1.HttpHelper.returnOkResponse(response)})),this.getFooter=(_event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const{baseUrl:baseUrl,parsers:parsers,configurations:configurations}=this.config,data=JSON.parse(yield helpers_1.HttpHelper.doRequest(baseUrl+"footer")),parser=new parsers.footer,response=parser.parse(data,{conf:configurations.footer});return helpers_1.HttpHelper.returnOkResponse(response)})),this.getTranslation=(event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const{baseUrl:baseUrl,parsers:parsers}=this.config,{lang:lang}=event.pathParameters,data=JSON.parse(yield helpers_1.HttpHelper.doRequest(baseUrl+"translations?lang="+lang)),parser=new parsers.translation,response=parser.parse({data:data,options:{lang:lang}});return helpers_1.HttpHelper.returnOkResponse(response)})),this.getStaticPage=(event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const{parsers:parsers,staticUrl:staticUrl}=this.config,{slug:slug}=event.pathParameters,data=JSON.parse(yield helpers_1.HttpHelper.doRequest(staticUrl+"pages?slug="+slug)),parser=new parsers.static,response=parser.parse({data:data});return response?helpers_1.HttpHelper.returnOkResponse(response):helpers_1.HttpHelper.returnErrorResponse("page not found",404)})),this.getStaticPost=(event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const{parsers:parsers,staticUrl:staticUrl}=this.config,{slug:slug}=event.pathParameters,data=JSON.parse(yield helpers_1.HttpHelper.doRequest(staticUrl+"posts?slug="+slug)),parser=new parsers.static,response=parser.parse({data:data});return response?helpers_1.HttpHelper.returnOkResponse(response):helpers_1.HttpHelper.returnErrorResponse("page not found",404)})),this.getTypeList=(event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const{parsers:parsers,staticUrl:staticUrl}=this.config,{type:type}=event.pathParameters,body=JSON.parse(event.body);let params="";body.results&&body.results.limit&&(params="per_page="+body.results.limit),body.results&&body.results.offset&&(params+=""==params?"offset="+body.results.offset:"&offset="+body.results.offset);const apiUrl=""!=params?staticUrl+type+"?"+params:staticUrl+type,data=JSON.parse(yield helpers_1.HttpHelper.doRequest(apiUrl)),parser=new parsers.static,response={results:parser.parseList({data:data,options:{type:type}}),limit:body.results.limit||10,offset:body.results.offset||0,total_count:data.length,sort:""};return helpers_1.HttpHelper.returnOkResponse(response)})),this.getItineraries=(event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const{parsers:parsers,baseUrl:baseUrl,configurations:configurations}=this.config,data=JSON.parse(yield helpers_1.HttpHelper.doRequest(baseUrl+"itinerary"))})),this.getItinerary=(event,_context,_callback)=>__awaiter(this,void 0,void 0,(function*(){const{parsers:parsers,baseUrl:baseUrl,configurations:configurations}=this.config,{id:id}=event.pathParameters,data=JSON.parse(yield helpers_1.HttpHelper.doRequest(baseUrl+"itinerary/"+id)),parser=new parsers.itinerary(null==configurations?void 0:configurations.itineraries),response=parser.parse({data:data});return response?helpers_1.HttpHelper.returnOkResponse(response):helpers_1.HttpHelper.returnErrorResponse("page not found",404)})),this.config=config}getSlsMethods(){return{postTest:this.postTest.bind(this),getTest:this.getTest.bind(this),getNavigation:this.getNavigation.bind(this),getFooter:this.getFooter.bind(this),getHomeLayout:this.getHomeLayout.bind(this),getSearchDescription:this.getSearchDescription.bind(this),getTimeline:this.getTimeline.bind(this),getMap:this.getMap.bind(this),getResource:this.getResource.bind(this),search:this.search.bind(this),advancedSearch:this.advancedSearch.bind(this),getTranslation:this.getTranslation.bind(this),getStaticPage:this.getStaticPage.bind(this),getStaticPost:this.getStaticPost.bind(this),getTypeList:this.getTypeList.bind(this),getItinerary:this.getItinerary.bind(this),getItineraries:this.getItineraries.bind(this)}}}exports.Controller=Controller;